<app-admin-layout>
  <div class="event-detail-page">
    <a routerLink="/admin/events" class="btn-back">â† Retour Ã  la liste</a>

    <div *ngIf="loading" class="loading">Chargement...</div>
    <div *ngIf="error" class="error">{{ error }}</div>

    <div *ngIf="!loading && event">
      <!-- Header Ã©vÃ©nement -->
      <header class="event-header">
        <div class="header-left">
          <span class="status-badge" [class]="getStatusClass(event.status)">{{ statusLabels[event.status] }}</span>
          <h1>{{ event.name }}</h1>
          <p class="client-info">
            Client :
            <a [routerLink]="['/admin/clients', event.client_id]">{{ event.client_company || 'N/A' }}</a>
          </p>
        </div>
        <div class="header-actions">
          <a [routerLink]="['/admin/events', event.id, 'edit']" class="btn btn-primary">âœï¸ Modifier</a>
          <button (click)="deleteEvent()" class="btn btn-danger">ğŸ—‘ï¸ Supprimer</button>
        </div>
      </header>

      <!-- Infos -->
      <section class="event-info card">
        <h3>â„¹ï¸ Informations</h3>
        <div class="info-grid">
          <div><strong>Date dÃ©but :</strong> {{ formatDate(event.start_date) }}</div>
          <div><strong>Date fin :</strong> {{ formatDate(event.end_date) }}</div>
          <div><strong>Lieu :</strong> {{ event.location || '-' }}</div>
          <div><strong>Type :</strong> {{ event.event_type || '-' }}</div>
          <div><strong>ThÃ¨me :</strong> {{ event.theme || '-' }}</div>
          <div><strong>Participants :</strong> {{ event.attendees_count || 0 }}</div>
          <div><strong>Budget :</strong> {{ formatCurrency(event.budget || 0) }}</div>
          <div><strong>Visible :</strong> {{ event.is_visible ? 'Oui' : 'Non' }}</div>
        </div>
        <p *ngIf="event.description"><strong>Description :</strong> {{ event.description }}</p>
      </section>

      <!-- Image -->
      <section class="event-image card" *ngIf="event.image_path">
        <h3>ğŸ–¼ï¸ Image</h3>
        <img [src]="getEventImage(event.image_path)" (error)="onImageError($event)" alt="Image Ã©vÃ©nement">
      </section>

      <!-- Actions statut -->
      <section class="status-actions" *ngIf="event.status !== 'completed' && event.status !== 'cancelled'">
        <h3>âš¡ Actions rapides</h3>
        <div class="status-buttons">
          <button *ngIf="event.status === 'draft'" (click)="updateStatus('client_review')" class="btn">
            ğŸ“¤ Envoyer au client
          </button>
          <button *ngIf="event.status === 'client_review'" (click)="updateStatus('accepted')" class="btn btn-success">
            âœ… Accepter
          </button>
          <button *ngIf="event.status === 'accepted'" (click)="updateStatus('in_progress')" class="btn btn-primary">
            ğŸš€ DÃ©marrer
          </button>
          <button *ngIf="event.status === 'in_progress'" (click)="updateStatus('completed')" class="btn btn-success">
            ğŸ‰ Terminer
          </button>
          <button *ngIf="event.status !== 'cancelled'" (click)="updateStatus('cancelled')" class="btn btn-outline">
            âŒ Annuler
          </button>
        </div>
      </section>

      <!-- Devis -->
      <section class="section-table">
        <div class="section-header">
          <h3>ğŸ’° Devis ({{ quotes.length }})</h3>
          <a [routerLink]="['/admin/quotes/create']" [queryParams]="{ event_id: event.id }" class="btn btn-sm">+ CrÃ©er un devis</a>
        </div>
        <div *ngIf="quotes.length === 0" class="empty">Aucun devis pour cet Ã©vÃ©nement</div>
        <table *ngIf="quotes.length > 0">
          <thead>
            <tr>
              <th>ID</th>
              <th>Montant TTC</th>
              <th>Statut</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let quote of quotes">
              <td><a [routerLink]="['/admin/quotes', quote.id]">#{{ quote.id }}</a></td>
              <td>{{ formatCurrency(quote.total_ttc) }}</td>
              <td><span class="badge">{{ quoteStatusLabels[quote.status] }}</span></td>
              <td>{{ formatDate(quote.created_at) }}</td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- TÃ¢ches -->
      <section class="section-table">
        <div class="section-header">
          <h3>âœ… TÃ¢ches ({{ tasks.length }})</h3>
          <button class="btn btn-sm" (click)="openTaskModal()">+ Ajouter une tÃ¢che</button>
        </div>
        <div *ngIf="tasks.length === 0" class="empty">Aucune tÃ¢che â€” ajoutez-en pour organiser cet Ã©vÃ©nement</div>
        <table *ngIf="tasks.length > 0">
          <thead>
            <tr>
              <th>TÃ¢che</th>
              <th>AssignÃ© Ã </th>
              <th>Ã‰chÃ©ance</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let task of tasks">
              <td>
                <strong>{{ task.title }}</strong>
                <small *ngIf="task.description" class="task-desc">{{ task.description }}</small>
              </td>
              <td>{{ task.assigned_first_name ? task.assigned_first_name + ' ' + task.assigned_last_name : 'Non assignÃ©' }}</td>
              <td>{{ task.due_date ? formatDate(task.due_date) : '-' }}</td>
              <td><span class="task-status" [class]="'task-' + task.status">{{ taskStatusLabels[task.status] }}</span></td>
              <td>
                <button (click)="deleteTask(task)" class="btn-icon btn-danger" title="Supprimer" [attr.aria-label]="'Supprimer la tÃ¢che '+ task.title">ğŸ—‘ï¸</button>
              </td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Notes -->
      <section class="section-notes">
        <div class="section-header">
          <h3>ğŸ“ Notes internes</h3>
        </div>
        
        <div class="add-note-form">
          <textarea 
            [(ngModel)]="newNoteContent" 
            placeholder="Ajouter une note interne..."
            rows="3"
          ></textarea>
          <button (click)="addNote()" [disabled]="addingNote || !newNoteContent.trim()" class="btn btn-primary">
            {{ addingNote ? 'Ajout...' : '+ Ajouter la note' }}
          </button>
        </div>

        <div *ngIf="notes.length === 0" class="empty">Aucune note pour cet Ã©vÃ©nement</div>
        
        <div class="notes-list" *ngIf="notes.length > 0">
          <div class="note-item" *ngFor="let note of notes">
            <div class="note-header">
              <div class="note-author">
                <span class="avatar">{{ note.first_name?.[0] }}{{ note.last_name?.[0] }}</span>
                <strong>{{ note.first_name }} {{ note.last_name }}</strong>
              </div>
              <div class="note-actions">
                <span class="note-date">{{ formatDate(note.created_at) }}</span>
                <button *ngIf="editingNoteId !== note.id" (click)="startEditNote(note)" class="btn-delete" title="Modifier" aria-label="Modifier la note">âœï¸</button>
                <button *ngIf="editingNoteId !== note.id" (click)="deleteNote(note)" class="btn-delete" title="Supprimer" aria-label="Supprimer la note">ğŸ—‘ï¸</button>
              </div>
            </div>

            <p *ngIf="editingNoteId !== note.id" class="note-content">{{ note.content }}</p>

            <div *ngIf="editingNoteId === note.id" class="note-edit">
              <textarea [(ngModel)]="editNoteContent" rows="3" placeholder="Modifier la note..."></textarea>
              <div class="edit-actions">
                <button class="btn btn-primary btn-sm" (click)="saveEditNote(note)">Enregistrer</button>
                <button class="btn btn-secondary btn-sm" (click)="cancelEditNote()">Annuler</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Modal Ajouter une tÃ¢che -->
    <div class="modal-overlay" *ngIf="showTaskModal" (click)="closeTaskModal()" (keydown.escape)="closeTaskModal()">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="task-modal-title" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2 id="task-modal-title">Nouvelle tÃ¢che</h2>
          <button class="btn-close" aria-label="Fermer la fenÃªtre" (click)="closeTaskModal()">Ã—</button>
        </div>
        <div class="modal-body">
          <div *ngIf="taskError" class="alert alert-danger">{{ taskError }}</div>

          <div class="form-group">
            <label for="new-task-title">Titre de la tÃ¢che *</label>
            <input id="new-task-title" #taskTitleInput type="text" [(ngModel)]="newTask.title" placeholder="Ex: RÃ©server la salle">
          </div>

          <div class="form-group">
            <label for="new-task-description">Description</label>
            <textarea id="new-task-description" [(ngModel)]="newTask.description" rows="3" placeholder="DÃ©tails optionnels..."></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="new-task-assigned-to">Assigner Ã </label>
              <select id="new-task-assigned-to" [(ngModel)]="newTask.assigned_to">
                <option value="">Non assignÃ©</option>
                <option *ngFor="let emp of employees" [value]="emp.id">
                  {{ emp.first_name }} {{ emp.last_name }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label for="new-task-due-date">Ã‰chÃ©ance</label>
              <input id="new-task-due-date" type="date" [(ngModel)]="newTask.due_date">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeTaskModal()">Annuler</button>
          <button class="btn btn-primary" (click)="createTask()" [disabled]="taskLoading">
            {{ taskLoading ? 'CrÃ©ation...' : 'CrÃ©er la tÃ¢che' }}
          </button>
        </div>
      </div>
    </div>

  </div>
</app-admin-layout>
