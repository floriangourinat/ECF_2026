<app-admin-layout>
  <div class="event-detail-page">
    <a routerLink="/admin/events" class="btn-back">â† Retour Ã  la liste</a>

    <div *ngIf="loading" class="loading">Chargement...</div>
    <div *ngIf="error" class="error">{{ error }}</div>

    <div *ngIf="event && !loading" class="event-content">
      <header class="event-header">
        <div class="header-info">
          <span class="status-badge" [class]="getStatusClass(event.status)">
            {{ statusLabels[event.status] }}
          </span>
          <h1>{{ event.name }}</h1>
          <p class="client-info">
            Client : <a [routerLink]="['/admin/clients', event.client_id]">
              {{ event.client_company || event.client_first_name + ' ' + event.client_last_name }}
            </a>
          </p>
        </div>
        <div class="header-actions">
          <a [routerLink]="['/admin/events', event.id, 'edit']" class="btn btn-primary">âœï¸ Modifier</a>
          <button (click)="deleteEvent()" class="btn btn-danger">ğŸ—‘ï¸ Supprimer</button>
        </div>
      </header>

      <!-- Image de l'Ã©vÃ©nement -->
      <section class="event-image-section">
        <img [src]="getEventImage(event.image_path)" [alt]="event.name" class="event-image" (error)="onImageError($event)">
      </section>

      <!-- Infos principales -->
      <div class="details-grid">
        <section class="detail-card">
          <h3>ğŸ“… Dates</h3>
          <div class="detail-row">
            <span class="label">DÃ©but</span>
            <span class="value">{{ formatDate(event.start_date) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Fin</span>
            <span class="value">{{ formatDate(event.end_date) }}</span>
          </div>
        </section>

        <section class="detail-card">
          <h3>ğŸ“ Lieu & Type</h3>
          <div class="detail-row">
            <span class="label">Lieu</span>
            <span class="value">{{ event.location || '-' }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Type</span>
            <span class="value">{{ event.event_type || '-' }}</span>
          </div>
          <div class="detail-row">
            <span class="label">ThÃ¨me</span>
            <span class="value">{{ event.theme || '-' }}</span>
          </div>
        </section>

        <section class="detail-card">
          <h3>âš™ï¸ ParamÃ¨tres</h3>
          <div class="detail-row">
            <span class="label">Visible au public</span>
            <span class="value">{{ event.is_visible ? 'Oui âœ…' : 'Non âŒ' }}</span>
          </div>
          <div class="detail-row">
            <span class="label">CrÃ©Ã© le</span>
            <span class="value">{{ formatDate(event.created_at) }}</span>
          </div>
        </section>
      </div>

      <!-- Actions rapides sur le statut -->
      <section class="status-actions" *ngIf="event.status !== 'completed' && event.status !== 'cancelled'">
        <h3>ğŸ”„ Changer le statut</h3>
        <div class="status-buttons">
          <button *ngIf="event.status === 'draft'" (click)="updateStatus('client_review')" class="btn">
            â†’ En attente client
          </button>
          <button *ngIf="event.status === 'client_review'" (click)="updateStatus('accepted')" class="btn btn-success">
            âœ… Marquer comme acceptÃ©
          </button>
          <button *ngIf="event.status === 'accepted'" (click)="updateStatus('in_progress')" class="btn btn-primary">
            ğŸš€ DÃ©marrer l'Ã©vÃ©nement
          </button>
          <button *ngIf="event.status === 'in_progress'" (click)="updateStatus('completed')" class="btn btn-success">
            ğŸ Terminer l'Ã©vÃ©nement
          </button>
          <button *ngIf="event.status !== 'cancelled'" (click)="updateStatus('cancelled')" class="btn btn-outline">
            âŒ Annuler
          </button>
        </div>
      </section>

      <!-- Devis -->
      <section class="section-table">
        <div class="section-header">
          <h3>ğŸ“„ Devis</h3>
          <a [routerLink]="['/admin/quotes/create']" [queryParams]="{event_id: event.id}" class="btn btn-sm">+ CrÃ©er un devis</a>
        </div>
        <div *ngIf="quotes.length === 0" class="empty">Aucun devis pour cet Ã©vÃ©nement</div>
        <table *ngIf="quotes.length > 0">
          <thead>
            <tr>
              <th>ID</th>
              <th>Montant TTC</th>
              <th>Statut</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let quote of quotes">
              <td><a [routerLink]="['/admin/quotes', quote.id]">#{{ quote.id }}</a></td>
              <td>{{ formatCurrency(quote.total_ttc) }}</td>
              <td><span class="badge">{{ quoteStatusLabels[quote.status] }}</span></td>
              <td>{{ formatDate(quote.created_at) }}</td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- TÃ¢ches -->
      <section class="section-table">
        <div class="section-header">
          <h3>âœ… TÃ¢ches ({{ tasks.length }})</h3>
          <button class="btn btn-sm" (click)="openTaskModal()">+ Ajouter une tÃ¢che</button>
        </div>
        <div *ngIf="tasks.length === 0" class="empty">Aucune tÃ¢che â€” ajoutez-en pour organiser cet Ã©vÃ©nement</div>
        <table *ngIf="tasks.length > 0">
          <thead>
            <tr>
              <th>TÃ¢che</th>
              <th>AssignÃ© Ã </th>
              <th>Ã‰chÃ©ance</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let task of tasks">
              <td>
                <strong>{{ task.title }}</strong>
                <small *ngIf="task.description" class="task-desc">{{ task.description }}</small>
              </td>
              <td>{{ task.assigned_first_name ? task.assigned_first_name + ' ' + task.assigned_last_name : 'Non assignÃ©' }}</td>
              <td>{{ task.due_date ? formatDate(task.due_date) : '-' }}</td>
              <td><span class="task-status" [class]="'task-' + task.status">{{ taskStatusLabels[task.status] }}</span></td>
              <td>
                <button (click)="deleteTask(task)" class="btn-icon btn-danger" title="Supprimer">ğŸ—‘ï¸</button>
              </td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Notes -->
      <section class="section-notes">
        <div class="section-header">
          <h3>ğŸ“ Notes internes</h3>
        </div>
        
        <div class="add-note-form">
          <textarea 
            [(ngModel)]="newNoteContent" 
            placeholder="Ajouter une note interne..."
            rows="3"
          ></textarea>
          <button (click)="addNote()" [disabled]="addingNote || !newNoteContent.trim()" class="btn btn-primary">
            {{ addingNote ? 'Ajout...' : '+ Ajouter la note' }}
          </button>
        </div>

        <div *ngIf="notes.length === 0" class="empty">Aucune note pour cet Ã©vÃ©nement</div>
        
        <div class="notes-list" *ngIf="notes.length > 0">
          <div class="note-item" *ngFor="let note of notes">
            <div class="note-header">
              <div class="note-author">
                <span class="avatar">{{ note.first_name?.[0] }}{{ note.last_name?.[0] }}</span>
                <strong>{{ note.first_name }} {{ note.last_name }}</strong>
              </div>
              <div class="note-actions">
                <span class="note-date">{{ formatDate(note.created_at) }}</span>
                <button (click)="deleteNote(note)" class="btn-delete" title="Supprimer">ğŸ—‘ï¸</button>
              </div>
            </div>
            <p class="note-content">{{ note.content }}</p>
          </div>
        </div>
      </section>
    </div>

    <!-- Modal Ajouter une tÃ¢che -->
    <div class="modal-overlay" *ngIf="showTaskModal" (click)="closeTaskModal()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Nouvelle tÃ¢che</h2>
          <button class="btn-close" (click)="closeTaskModal()">Ã—</button>
        </div>
        <div class="modal-body">
          <div *ngIf="taskError" class="alert alert-danger">{{ taskError }}</div>

          <div class="form-group">
            <label>Titre de la tÃ¢che *</label>
            <input type="text" [(ngModel)]="newTask.title" placeholder="Ex: RÃ©server la salle">
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea [(ngModel)]="newTask.description" rows="3" placeholder="DÃ©tails optionnels..."></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Assigner Ã </label>
              <select [(ngModel)]="newTask.assigned_to">
                <option value="">Non assignÃ©</option>
                <option *ngFor="let emp of employees" [value]="emp.id">
                  {{ emp.first_name }} {{ emp.last_name }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label>Ã‰chÃ©ance</label>
              <input type="date" [(ngModel)]="newTask.due_date">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeTaskModal()">Annuler</button>
          <button class="btn btn-primary" (click)="createTask()" [disabled]="taskLoading">
            {{ taskLoading ? 'CrÃ©ation...' : 'CrÃ©er la tÃ¢che' }}
          </button>
        </div>
      </div>
    </div>

  </div>
</app-admin-layout>
