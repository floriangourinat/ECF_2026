<app-admin-layout>
  <div class="quote-detail-page">
    <a routerLink="/admin/quotes" class="btn-back">‚Üê Retour √† la liste</a>

    <div *ngIf="loading" class="loading">Chargement...</div>
    <div *ngIf="error" class="error">{{ error }}</div>

    <div *ngIf="quote && !loading" class="quote-content">
      <header class="quote-header">
        <div class="header-info">
          <span class="status-badge" [class]="getStatusClass(quote.status)">
            {{ statusLabels[quote.status] }}
          </span>
          <h1>Devis #{{ quote.id }}</h1>
          <p class="quote-date">√âmis le {{ formatDate(quote.issue_date) }}</p>
        </div>
        <div class="header-actions">
          <button (click)="downloadPdf()" class="btn btn-primary">üìÑ T√©l√©charger PDF</button>
          <button (click)="sendByEmail()" class="btn btn-success" [disabled]="sending">
            {{ sending ? 'üìß Envoi...' : 'üìß Envoyer par email' }}
          </button>
          <button (click)="deleteQuote()" class="btn btn-danger">üóëÔ∏è Supprimer</button>
        </div>
      </header>

      <!-- Infos client et √©v√©nement -->
      <div class="details-grid">
        <section class="detail-card">
          <h3>üë§ Client</h3>
          <div class="detail-row">
            <span class="label">Nom</span>
            <span class="value">{{ quote.company_name || quote.first_name + ' ' + quote.last_name }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Email</span>
            <span class="value">{{ quote.client_email }}</span>
          </div>
          <div class="detail-row">
            <span class="label">T√©l√©phone</span>
            <span class="value">{{ quote.client_phone || '-' }}</span>
          </div>
        </section>

        <section class="detail-card">
          <h3>üéâ √âv√©nement</h3>
          <div class="detail-row">
            <span class="label">Nom</span>
            <span class="value">
              <a [routerLink]="['/admin/events', quote.event_id]">{{ quote.event_name }}</a>
            </span>
          </div>
          <div class="detail-row">
            <span class="label">Date</span>
            <span class="value">{{ formatDate(quote.event_date) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Lieu</span>
            <span class="value">{{ quote.event_location || '-' }}</span>
          </div>
        </section>
      </div>

      <!-- Prestations -->
      <section class="services-section">
        <h3>üìã Prestations</h3>
        <table class="services-table">
          <thead>
            <tr>
              <th>Prestation</th>
              <th>Description</th>
              <th>Montant HT</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let service of services">
              <td>{{ service.label }}</td>
              <td>{{ service.description || '-' }}</td>
              <td class="amount">{{ formatCurrency(service.unit_price_ht) }}</td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="2" class="total-label">Total HT</td>
              <td class="amount">{{ formatCurrency(quote.total_ht) }}</td>
            </tr>
            <tr>
              <td colspan="2" class="total-label">TVA ({{ quote.tax_rate }}%)</td>
              <td class="amount">{{ formatCurrency(quote.total_ttc - quote.total_ht) }}</td>
            </tr>
            <tr class="total-row">
              <td colspan="2" class="total-label">Total TTC</td>
              <td class="amount">{{ formatCurrency(quote.total_ttc) }}</td>
            </tr>
          </tfoot>
        </table>
      </section>

      <!-- Motif de modification -->
      <section class="modification-section" *ngIf="quote.modification_reason">
        <h3>üìù Demande de modification</h3>
        <p *ngIf="getClientModificationReason(quote.modification_reason)">
          <strong>Motif client :</strong> {{ getClientModificationReason(quote.modification_reason) }}
        </p>
        <p *ngIf="getCounterProposal(quote.modification_reason)">
          <strong>Derni√®re contreproposition :</strong> {{ getCounterProposal(quote.modification_reason) }}
        </p>
        <p *ngIf="getCounterProposalDate(quote.modification_reason)">
          <strong>Date :</strong> {{ getCounterProposalDate(quote.modification_reason) }}
        </p>
      </section>

      <section class="counter-proposal-section" *ngIf="quote.status === 'modification'">
        <h3>‚ÜîÔ∏è Contreproposition client</h3>
        <p>R√©pondez √† la demande de modification du client. Le devis repassera en √©tude c√¥t√© client.</p>
        <textarea rows="4" [(ngModel)]="counterProposalText" placeholder="Ex: Nous proposons une nouvelle formule √† 2 450‚Ç¨ TTC incluant ..."></textarea>
        <button (click)="sendCounterProposal()" class="btn btn-primary" [disabled]="sendingCounterProposal">
          {{ sendingCounterProposal ? 'Envoi...' : 'Envoyer la contreproposition' }}
        </button>
      </section>

      <!-- Actions sur le statut -->
      <section class="status-actions" *ngIf="quote.status === 'pending' || quote.status === 'modification'">
        <h3>üîÑ Actions</h3>
        <div class="action-buttons">
          <button (click)="updateStatus('accepted')" class="btn btn-success">‚úÖ Marquer comme accept√©</button>
          <button (click)="updateStatus('refused')" class="btn btn-outline">‚ùå Marquer comme refus√©</button>
        </div>
      </section>
    </div>
  </div>
</app-admin-layout>
