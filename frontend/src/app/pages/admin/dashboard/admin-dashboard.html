<app-admin-layout>
  <div class="dashboard">
    <header class="dashboard-header">
      <h1>Tableau de bord</h1>
      <p>Bienvenue sur votre espace d'administration</p>
    </header>

    <div *ngIf="loading" class="loading">
      <p>Chargement...</p>
    </div>

    <div *ngIf="error" class="error">
      <p>{{ error }}</p>
    </div>

    <div *ngIf="data && !loading" class="dashboard-content">
      <section class="stats-section">
        <div class="stat-card highlight">
          <div class="stat-icon">ğŸ¯</div>
          <div class="stat-info">
            <span class="stat-value">{{ data.stats.prospects_to_contact }}</span>
            <span class="stat-label">Prospects Ã  contacter</span>
          </div>
          <a routerLink="/admin/prospects" class="stat-link">Voir â†’</a>
        </div>

        <div class="stat-card">
          <div class="stat-icon">ğŸ“</div>
          <div class="stat-info">
            <span class="stat-value">{{ data.stats.draft_events }}</span>
            <span class="stat-label">Ã‰vÃ©nements brouillon</span>
          </div>
          <a routerLink="/admin/events" class="stat-link">Voir â†’</a>
        </div>

        <div class="stat-card">
          <div class="stat-icon">ğŸ‘¥</div>
          <div class="stat-info">
            <span class="stat-value">{{ data.stats.active_clients }}</span>
            <span class="stat-label">Clients actifs</span>
          </div>
          <a routerLink="/admin/clients" class="stat-link">Voir â†’</a>
        </div>

        <div class="stat-card">
          <div class="stat-icon">ğŸ“„</div>
          <div class="stat-info">
            <span class="stat-value">{{ data.stats.pending_quotes }}</span>
            <span class="stat-label">Devis en attente</span>
          </div>
          <a routerLink="/admin/quotes" class="stat-link">Voir â†’</a>
        </div>

        <div class="stat-card accepted-card">
          <div class="stat-icon">âœ…</div>
          <div class="stat-info">
            <span class="stat-value">{{ data.stats.accepted_quotes }}</span>
            <span class="stat-label">Devis acceptÃ©s</span>
          </div>
          <a routerLink="/admin/quotes" [queryParams]="{ status: 'accepted' }" class="stat-link">Voir â†’</a>
        </div>

        <div class="stat-card">
          <div class="stat-icon">ğŸ¢</div>
          <div class="stat-info">
            <span class="stat-value">{{ data.stats.total_clients }}</span>
            <span class="stat-label">Total clients</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">ğŸ‰</div>
          <div class="stat-info">
            <span class="stat-value">{{ data.stats.total_events }}</span>
            <span class="stat-label">Total Ã©vÃ©nements</span>
          </div>
        </div>
      </section>

      <div class="widgets-grid">
        <section class="widget">
          <div class="widget-header">
            <h2>ğŸ—“ï¸ Prochains Ã©vÃ©nements</h2>
            <a routerLink="/admin/events" class="widget-link">Voir tout</a>
          </div>
          <div class="widget-content">
            <div *ngIf="data.upcoming_events.length === 0" class="empty-state">
              <p>Aucun Ã©vÃ©nement Ã  venir</p>
            </div>
            <div *ngFor="let event of data.upcoming_events" class="event-item">
              <div class="event-date">
                <span class="day">{{ event.start_date | date:'dd' }}</span>
                <span class="month">{{ event.start_date | date:'MMM' }}</span>
              </div>
              <div class="event-info">
                <h4>{{ event.name }}</h4>
                <p class="event-client">{{ event.client_company || 'Client non assignÃ©' }}</p>
                <p class="event-location">ğŸ“ {{ event.location }}</p>
              </div>
              <span class="status-badge" [class]="getStatusClass(event.status)">
                {{ getStatusLabel(event.status) }}
              </span>
            </div>
          </div>
        </section>

        <section class="widget">
          <div class="widget-header">
            <h2>ğŸ“ Notes rÃ©centes</h2>
          </div>
          <div class="widget-content">
            <div *ngIf="data.recent_notes.length === 0" class="empty-state">
              <p>Aucune note rÃ©cente</p>
            </div>
            <div *ngFor="let note of data.recent_notes" class="note-item">
              <div class="note-header">
                <span class="note-author">{{ note.first_name }} {{ note.last_name }}</span>
                <span class="note-date">{{ formatDateTime(note.created_at) }}</span>
              </div>
              <p class="note-content">{{ note.content | slice:0:100 }}{{ note.content.length > 100 ? '...' : '' }}</p>
              <span *ngIf="note.event_name" class="note-event">ğŸ“Œ {{ note.event_name }}</span>
              <span *ngIf="note.is_global" class="note-global">ğŸŒ Note globale</span>
            </div>
          </div>
        </section>

        <section class="widget global-notes-widget">
          <div class="widget-header">
            <h2>ğŸŒ Notes globales</h2>
          </div>

          <div class="widget-content">
            <div class="global-note-form">
              <textarea
                [(ngModel)]="newGlobalNote"
                rows="3"
                placeholder="Ajouter une communication globale..."
              ></textarea>
              <button (click)="addGlobalNote()" [disabled]="savingGlobalNote || !newGlobalNote.trim()" class="btn-add-global-note">
                {{ savingGlobalNote ? 'Ajout...' : '+ Ajouter la note globale' }}
              </button>
            </div>

            <div *ngIf="data.global_notes.length === 0" class="empty-state">
              <p>Aucune note globale</p>
            </div>

            <div class="notes-list" *ngIf="data.global_notes.length > 0">
              <div class="note-item" *ngFor="let note of data.global_notes">
                <div class="note-header">
                  <span class="note-author">{{ note.first_name }} {{ note.last_name }}</span>
                  <span class="note-date">{{ formatDateTime(note.created_at) }}</span>
                </div>

                <p *ngIf="editingGlobalNoteId !== note.id" class="note-content">{{ note.content }}</p>

                <div *ngIf="editingGlobalNoteId === note.id" class="note-edit">
                  <textarea [(ngModel)]="editGlobalNoteContent" rows="3"></textarea>
                  <div class="edit-actions">
                    <button class="btn-save" (click)="saveEditGlobalNote(note)">Enregistrer</button>
                    <button class="btn-cancel" (click)="cancelEditGlobalNote()">Annuler</button>
                  </div>
                </div>

                <div *ngIf="editingGlobalNoteId !== note.id" class="note-actions">
                  <button class="btn-edit" (click)="startEditGlobalNote(note)" aria-label="Modifier la note globale">âœï¸</button>
                  <button class="btn-delete" (click)="deleteGlobalNote(note)" aria-label="Supprimer la note globale">ğŸ—‘ï¸</button>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>
</app-admin-layout>
